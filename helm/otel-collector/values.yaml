# Default values for otel-collector
replicaCount: 2

image:
  repository: otel/opentelemetry-collector-contrib
  pullPolicy: IfNotPresent
  tag: "0.91.0"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations:
    # This will be populated by Terraform output
    eks.amazonaws.com/role-arn: ""
  name: "otel-collector"

podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8888"
  prometheus.io/path: "/metrics"

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000

service:
  type: ClusterIP
  ports:
    otlp-grpc:
      port: 4317
      targetPort: 4317
      protocol: TCP
    otlp-http:
      port: 4318
      targetPort: 4318
      protocol: TCP
    metrics:
      port: 8888
      targetPort: 8888
      protocol: TCP
    prometheus:
      port: 9090
      targetPort: 9090
      protocol: TCP

resources:
  limits:
    cpu: 1000m
    memory: 2Gi
  requests:
    cpu: 200m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app.kubernetes.io/name
            operator: In
            values:
            - otel-collector
        topologyKey: kubernetes.io/hostname

# Environment Configuration
environment: "dev"  # Override per environment: dev/staging/prod
clusterName: "nebula-eks-dev"  # Override per environment

# AWS Configuration
aws:
  region: "ap-northeast-2"
  amp:
    workspaceId: ""  # Will be populated from Terraform
    endpoint: ""     # Will be populated from Terraform
  cloudwatch:
    namespace: "Nebula/Application"
    logGroup: ""  # Will be populated from Terraform output
    logStreamPrefix: "otel"
  xray:
    region: "ap-northeast-2"

# OTEL Collector Configuration
config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
    prometheus:
      config:
        scrape_configs:
          - job_name: 'kubernetes-pods'
            kubernetes_sd_configs:
              - role: pod
            relabel_configs:
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                action: keep
                regex: true
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                action: replace
                target_label: __metrics_path__
                regex: (.+)
              - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                action: replace
                regex: ([^:]+)(?::\d+)?;(\d+)
                replacement: $1:$2
                target_label: __address__
              - action: labelmap
                regex: __meta_kubernetes_pod_label_(.+)
              - source_labels: [__meta_kubernetes_namespace]
                action: replace
                target_label: kubernetes_namespace
              - source_labels: [__meta_kubernetes_pod_name]
                action: replace
                target_label: kubernetes_pod_name

  processors:
    batch:
      timeout: 10s
      send_batch_size: 1024
    memory_limiter:
      check_interval: 1s
      limit_mib: 1536
      spike_limit_mib: 512
    resource:
      attributes:
        - key: cluster.name
          value: "${CLUSTER_NAME}"
          action: insert
        - key: deployment.environment
          value: "${ENVIRONMENT}"
          action: insert
    attributes:
      actions:
        - key: http.user_agent
          action: delete
    filter:
      metrics:
        exclude:
          match_type: regexp
          metric_names:
            - ".*_bucket"
            - ".*_created"

  exporters:
    prometheusremotewrite:
      endpoint: "${AWS_AMP_ENDPOINT}/api/v1/remote_write"
      auth:
        authenticator: sigv4auth
      resource_to_telemetry_conversion:
        enabled: true
    awscloudwatchlogs:
      region: "${AWS_REGION}"
      log_group_name: "${CLOUDWATCH_LOG_GROUP}"
      log_stream_name: "${CLOUDWATCH_LOG_STREAM}"
    awsxray:
      region: "${AWS_REGION}"
      no_verify_ssl: false
      local_mode: false
    logging:
      loglevel: info

  extensions:
    health_check:
      endpoint: 0.0.0.0:13133
    pprof:
      endpoint: 0.0.0.0:1777
    zpages:
      endpoint: 0.0.0.0:55679
    sigv4auth:
      region: "${AWS_REGION}"
      service: "aps"

  service:
    extensions: [health_check, pprof, zpages, sigv4auth]
    pipelines:
      metrics:
        receivers: [otlp, prometheus]
        processors: [memory_limiter, batch, resource, filter]
        exporters: [prometheusremotewrite, logging]
      traces:
        receivers: [otlp]
        processors: [memory_limiter, batch, resource, attributes]
        exporters: [awsxray, logging]
      logs:
        receivers: [otlp]
        processors: [memory_limiter, batch, resource]
        exporters: [awscloudwatchlogs, logging]

# ServiceMonitor for Prometheus Operator (optional)
serviceMonitor:
  enabled: false  # Enable only if Prometheus Operator is installed
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: prometheus
