# ========================================
# OTEL Collector Helm Values
# terraform_new 인프라 모니터링용
# ========================================

# Terraform outputs에서 주입될 값들:
# - serviceAccount.annotations.eks.amazonaws.com/role-arn: ${target_otel_role_arn}
# - config.exporters.prometheusremotewrite.endpoint: ${amp_remote_write_url}
# - config.exporters.awscloudwatchlogs.log_group_name: ${target_log_group}
# - config.exporters.awsxray.region: ${aws_region}

mode: deployment  # 단일 Pod로 배포 (포트 충돌 방지)
replicaCount: 1

image:
  repository: otel/opentelemetry-collector-contrib
  tag: 0.97.0

serviceAccount:
  create: true
  name: otel-collector
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::961341535601:role/eks-cluster-xeyy1dqr-otel-collector-role"

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 200m
    memory: 256Mi

config:
  receivers:
    # ========================================
    # Prometheus 메트릭 수집
    # ========================================
    prometheus:
      config:
        scrape_configs:
          # Kubernetes API Server
          - job_name: 'kubernetes-apiservers'
            kubernetes_sd_configs:
              - role: endpoints
            scheme: https
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            relabel_configs:
              - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
                action: keep
                regex: default;kubernetes;https

          # Kubernetes Nodes (kubelet)
          - job_name: 'kubernetes-nodes'
            kubernetes_sd_configs:
              - role: node
            scheme: https
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            relabel_configs:
              - action: labelmap
                regex: __meta_kubernetes_node_label_(.+)
              - target_label: __address__
                replacement: kubernetes.default.svc:443
              - source_labels: [__meta_kubernetes_node_name]
                regex: (.+)
                target_label: __metrics_path__
                replacement: /api/v1/nodes/${1}/proxy/metrics

          # Kubernetes cAdvisor (컨테이너 메트릭)
          - job_name: 'kubernetes-cadvisor'
            kubernetes_sd_configs:
              - role: node
            scheme: https
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
            bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            relabel_configs:
              - action: labelmap
                regex: __meta_kubernetes_node_label_(.+)
              - target_label: __address__
                replacement: kubernetes.default.svc:443
              - source_labels: [__meta_kubernetes_node_name]
                regex: (.+)
                target_label: __metrics_path__
                replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor

          # Kubernetes Pods (애플리케이션 메트릭)
          - job_name: 'kubernetes-pods'
            kubernetes_sd_configs:
              - role: pod
            relabel_configs:
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                action: keep
                regex: true
              - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                action: replace
                target_label: __metrics_path__
                regex: (.+)
              - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                action: replace
                regex: ([^:]+)(?::\d+)?;(\d+)
                replacement: $1:$2
                target_label: __address__
              - action: labelmap
                regex: __meta_kubernetes_pod_label_(.+)
              - source_labels: [__meta_kubernetes_namespace]
                target_label: namespace
              - source_labels: [__meta_kubernetes_pod_name]
                target_label: pod
              - source_labels: [__meta_kubernetes_pod_label_app]
                target_label: service
              - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
                target_label: service
                regex: (.+)
                action: replace

          # ========================================
          # Kube-State-Metrics (클러스터 상태 메트릭)
          # ========================================
          - job_name: 'kube-state-metrics'
            kubernetes_sd_configs:
              - role: endpoints
            relabel_configs:
              - source_labels: [__meta_kubernetes_service_label_app_kubernetes_io_name]
                action: keep
                regex: kube-state-metrics
              - source_labels: [__meta_kubernetes_namespace]
                target_label: namespace
              - source_labels: [__meta_kubernetes_pod_name]
                target_label: pod

    # ========================================
    # OTLP Receiver (애플리케이션 트레이스)
    # ========================================
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318


  processors:
    # ========================================
    # Batch Processor
    # ========================================
    batch:
      timeout: 10s
      send_batch_size: 1024

    # ========================================
    # Resource Detection (AWS 메타데이터)
    # ========================================
    resourcedetection:
      detectors: [env, ec2, eks]
      timeout: 5s
      override: false

    # ========================================
    # Memory Limiter
    # ========================================
    memory_limiter:
      check_interval: 1s
      limit_mib: 512
      spike_limit_mib: 128

    # ========================================
    # Resource Processor (공통 라벨 추가)
    # ========================================
    resource:
      attributes:
        - key: cluster
          value: terraform-new
          action: upsert
        - key: environment
          value: dev
          action: upsert
        - key: source
          value: terraform-new-infrastructure
          action: upsert

    # ========================================
    # Attributes Processor (레이블 추가)
    # ========================================
    attributes:
      actions:
        - key: environment
          value: dev
          action: insert
        - key: source
          value: terraform-new-infrastructure
          action: insert

    # ========================================
    # Metrics Transform (메트릭 가공)
    # ========================================
    metricstransform:
      transforms:
        # CPU 사용률 계산용 라벨 정리
        - include: container_cpu_usage_seconds_total
          action: update
          operations:
            - action: aggregate_labels
              label_set: [namespace, pod, container]
              aggregation_type: sum
        # 메모리 사용량 라벨 정리
        - include: container_memory_working_set_bytes
          action: update
          operations:
            - action: aggregate_labels
              label_set: [namespace, pod, container]
              aggregation_type: sum
        # 불필요한 메트릭 필터링 (카디널리티 감소)
        - include: "^container_.*"
          match_type: regexp
          action: update
          operations:
            - action: delete_label_value
              label: id
            - action: delete_label_value
              label: name

    # ========================================
    # Filter Processor (불필요 메트릭 제거)
    # ========================================
    filter:
      metrics:
        exclude:
          match_type: regexp
          metric_names:
            # 고카디널리티 / 불필요 메트릭 제거
            - "go_.*"
            - "process_.*"
            - "promhttp_.*"

  exporters:
    # ========================================
    # Prometheus Remote Write (AMP)
    # ========================================
    prometheusremotewrite:
      endpoint: "https://aps-workspaces.ap-northeast-2.amazonaws.com/workspaces/ws-aca956f6-39cb-4c32-b4c4-073de9e9ec0a/api/v1/remote_write"
      auth:
        authenticator: sigv4auth

    # ========================================
    # CloudWatch Logs
    # ========================================
    awscloudwatchlogs:
      log_group_name: "/aws/eks/eks-cluster-xeyy1dqr/otel-collector"
      log_stream_name: otel-collector
      region: ap-northeast-2

    # ========================================
    # AWS X-Ray
    # ========================================
    awsxray:
      region: ap-northeast-2

    # ========================================
    # Logging (디버깅용)
    # ========================================
    logging:
      loglevel: info

  extensions:
    # ========================================
    # SigV4 Auth (AMP 인증)
    # ========================================
    sigv4auth:
      region: ap-northeast-2
      service: aps

    # ========================================
    # Health Check
    # ========================================
    health_check:
      endpoint: :13133

  service:
    extensions: [sigv4auth, health_check]
    telemetry:
      metrics:
        level: none  # 내부 메트릭 비활성화 (8888 포트 충돌 방지)
    
    pipelines:
      # ========================================
      # 메트릭 파이프라인
      # ========================================
      metrics:
        receivers: [prometheus]
        processors: [memory_limiter, resourcedetection, resource, attributes, filter, metricstransform, batch]
        exporters: [prometheusremotewrite, logging]

      # ========================================
      # 트레이스 파이프라인
      # ========================================
      traces:
        receivers: [otlp]
        processors: [memory_limiter, resourcedetection, attributes, batch]
        exporters: [awsxray, logging]

      # ========================================
      # 로그 파이프라인
      # ========================================
      logs:
        receivers: [otlp]
        processors: [memory_limiter, resourcedetection, attributes, batch]
        exporters: [awscloudwatchlogs, logging]

# ========================================
# Service Ports
# ========================================
ports:
  metrics:
    enabled: false  # 내부 메트릭 포트 비활성화 (8888 충돌 방지)
  prometheus:
    enabled: false  # prometheus 포트 비활성화
  otlp:
    enabled: true
    containerPort: 4317
    servicePort: 4317
    protocol: TCP
  otlp-http:
    enabled: true
    containerPort: 4318
    servicePort: 4318
    protocol: TCP
  health:
    enabled: true
    containerPort: 13133
    servicePort: 13133
    protocol: TCP
  jaeger-compact:
    enabled: false
  jaeger-thrift:
    enabled: false
  jaeger-grpc:
    enabled: false
  zipkin:
    enabled: false

# ========================================
# Tolerations (모든 노드에 배포)
# ========================================
tolerations:
  - operator: Exists

# ========================================
# Priority Class
# ========================================
priorityClassName: system-node-critical
